<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tyson-with-a-bat-vs.-30-HS-with-a-scissor</title>
  <style>
    :root {
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#1e293b;
      --border:#334155;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#3b82f6;
      --emerald:#22c55e;
      --warn:#facc15;
      --danger:#ef4444;
      --orange:#fb923c;
      --epstone:#a855f7;
    }
    html,body {
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    .wrap {
      position:relative;
      height:92vh;
      min-height:560px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    canvas {
      border:1px solid var(--border);
      border-radius:12px;
      touch-action:none;
      background:#07101f;
    }
    .hud {
      position:absolute;
      top:12px;
      left:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card {
      background:rgba(15,23,42,.7);
      backdrop-filter:blur(6px);
      border-radius:12px;
      padding:8px 12px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .grid {
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:8px;
    }
    .tile { background:rgba(15,23,42,.7); border-radius:10px; padding:8px 10px; }
    .muted { font-size:12px; color:var(--muted); }
    .big { font-weight:700; font-size:20px; }

    .controls {
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    .row { display:flex; gap:8px; align-items:center; }
    select,button,input[type="checkbox"] {
      background:rgba(15,23,42,.8);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-weight:600;
    }
    label.switch { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); background:rgba(15,23,42,.6); border:1px solid var(--border); padding:6px 10px; border-radius:10px; }
    button.start { background:var(--emerald); color:var(--bg); border:0; }
    button.reset { background:#fbbf24; color:#111827; border:0; }
    button.play { background:#38bdf8; color:#0b141e; border:0; }

    .overlay {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .panel {
      max-width:740px;
      background:rgba(15,23,42,.88);
      border:1px solid var(--border);
      border-radius:18px;
      padding:20px;
      text-align:center;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .panel .actions { display:flex; gap:10px; justify-content:center; margin-top:10px; }
    .hint {
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      color:var(--muted);
      font-size:12px;
      background:rgba(2,6,23,.6);
      padding:6px 10px;
      border-radius:999px;
    }
    .hide { display:none; }

    .hud, .controls { z-index:10; }
    .overlay { z-index:50; }

    /* Countdown styles */
    .countNum {
      font-size:64px;
      font-weight:900;
      letter-spacing:0.03em;
      margin:0.2rem 0 0.25rem;
    }
    .countSub {
      color:#cbd5e1;
      margin:0 0 0.6rem;
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <canvas id="game"></canvas>

    <!-- ERROR OVERLAY (shows script errors even on mobile) -->
    <div id="errOverlay" class="overlay hide">
      <div class="panel">
        <div style="font-weight:800;font-size:20px;margin-bottom:6px">Script error</div>
        <pre id="errMsg" style="white-space:pre-wrap;text-align:left;color:#e5e7eb;margin:0"></pre>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="card">
        <div class="muted" style="text-transform:uppercase;letter-spacing:.08em">Mode</div>
        <div class="big">Tyson-with-a-bat vs. 30 HS (scissors)</div>
      </div>
      <div class="grid">
        <div class="tile"><div class="muted">HP</div><div class="big" id="hp">3</div></div>
        <div class="tile"><div class="muted">Enemies</div><div class="big" id="enemies">0</div></div>
        <div class="tile"><div class="muted">Score</div><div class="big" id="score">0</div></div>
        <div class="tile"><div class="muted">Time</div><div class="big" id="time">0s</div></div>
        <div class="tile"><div class="muted">Flame</div><div class="big" id="flame">0s</div></div>
        <div class="tile"><div class="muted">Kills</div><div class="big" id="kills">0/0</div></div>
        <div class="tile"><div class="muted">Best</div><div class="big" id="best">0</div></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="row card" style="gap:12px; align-items:center;">
        <span class="muted">Difficulty</span>
        <select id="diff">
          <option value="1">Easy (24)</option>
          <option value="2" selected>Normal (30)</option>
          <option value="3">Hard (36)</option>
        </select>
        <label class="switch"><input id="crazy" type="checkbox" /> Wild Mode</label>
        <label class="switch"><input id="mute" type="checkbox" /> Mute</label>
      </div>
      <div class="row">
        <button class="play" id="restartBtn" type="button">Restart (reload)</button>
        <button class="reset" id="resetBtn" type="button">Reset (in-place)</button>
      </div>
    </div>

    <!-- Start overlay with countdown -->
    <div class="overlay" id="startOverlay">
      <div class="panel">
        <h1 class="countNum" id="countNum">3</h1>
        <div class="countSub" id="countLabel">Starting inâ€¦</div>
        <p style="margin:0 0 12px; color:#cbd5e1">
          Kite the swarm, use desks as choke points, and time your bat swing.<br>
          Elites can drop a <span style="color:var(--warn);font-weight:700">Flame Bat</span>. After 10 kills, beware: a massive purple Epstone will enter the fray!
        </p>
      </div>
    </div>

    <!-- End overlay -->
    <div class="overlay hide" id="endOverlay">
      <div class="panel">
        <div id="endTitle" style="font-size:28px;font-weight:800;margin-bottom:8px">Result</div>
        <div id="endMsg" style="color:#cbd5e1;margin-bottom:14px">â€”</div>
        <div class="actions">
          <button id="againBtn" class="play" type="button">Restart (reload)</button>
          <a id="shareBtn" class="play" href="#" target="_blank" style="text-decoration:none;display:inline-block;padding:.6rem 1rem;border-radius:10px;border:0;background:#64748b;color:#0b141e;font-weight:700">Share</a>
        </div>
      </div>
    </div>

    <div class="hint">Tip: Strike as the front ranks touch your arc. Elites drop flames â€” grab them for wider, hotter swings. Outscore Epstone to avoid a final showdown!</div>
  </div>

  <!-- Early-safe stub (kept harmless) -->
  <script>
    window.wantStart = false;
    window.startGame = function () { window.wantStart = true; };
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    (function(){
      const wrap=document.getElementById('wrap');
      const canvas=document.getElementById('game');
      const ctx=canvas.getContext('2d');

      // Error overlay (shows boot errors)
      const errOverlay=document.getElementById('errOverlay');
      const errMsg=document.getElementById('errMsg');
      function showErr(msg){ if(errOverlay&&errMsg){ errMsg.textContent=String(msg); errOverlay.classList.remove('hide'); } }
      window.addEventListener('error', e => showErr(e.error?.stack||e.message||e));
      window.addEventListener('unhandledrejection', e => showErr(e.reason?.stack||e.reason||e));

      /* ===== Safe localStorage (prevents iframe/mobile SecurityError) ===== */
      const storage = (() => {
        try { const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
        catch { return {getItem:()=>null,setItem:()=>{},removeItem:()=>{}}; }
      })();

      /* ===== Utilities ===== */
      const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
      const len=(x,y)=>Math.hypot(x,y);
      const norm=(x,y)=>{const L=Math.hypot(x,y)||1;return[x/L,y/L];};
      function withinArc(px,py,cx,cy,ang,arc,range){
        const dx=px-cx,dy=py-cy,d=Math.hypot(dx,dy);
        if(d>range) return false;
        const a=Math.atan2(dy,dx);
        const diff=Math.atan2(Math.sin(a-ang),Math.cos(a-ang));
        return Math.abs(diff)<=arc*0.5;
      }
      function circleRectCollide(c,r){
        const nx=clamp(c.x,r.x,r.x+r.w);
        const ny=clamp(c.y,r.y,r.y+r.h);
        const dx=c.x-nx,dy=c.y-ny;
        return dx*dx+dy*dy<c.r*c.r;
      }
      function randRange(a,b){ return a + Math.random()*(b-a); }
      function addShake(a){ state.shake = Math.min(1, (state.shake||0) + a); }
      const show=(el)=>el && el.classList.remove('hide');
      const hide=(el)=>el && el.classList.add('hide');

      /* ===== HUD refs ===== */
      const hpEl=document.getElementById('hp');
      const enemiesEl=document.getElementById('enemies');
      const scoreEl=document.getElementById('score');
      const timeEl=document.getElementById('time');
      const flameEl=document.getElementById('flame');
      const killsEl=document.getElementById('kills');
      const bestEl=document.getElementById('best');
      const diffSel=document.getElementById('diff');
      const crazyChk=document.getElementById('crazy');
      const muteChk=document.getElementById('mute');
      const startOverlay=document.getElementById('startOverlay');
      const endOverlay=document.getElementById('endOverlay');
      const endTitle=document.getElementById('endTitle');
      const endMsg=document.getElementById('endMsg');
      const resetBtn=document.getElementById('resetBtn');
      const shareBtn=document.getElementById('shareBtn');
      const restartBtn=document.getElementById('restartBtn');
      const againBtn=document.getElementById('againBtn');
      const countNum=document.getElementById('countNum');
      const countLabel=document.getElementById('countLabel');

      /* ===== Audio (defensive) ===== */
      let audioCtx=null, masterGain=null, musicGain=null, musicOsc=null;
      function ensureAudio(){
        if(audioCtx) return;
        try{
          audioCtx=new (window.AudioContext||window.webkitAudioContext)();
          masterGain=audioCtx.createGain(); masterGain.gain.value=0.12; masterGain.connect(audioCtx.destination);
          musicGain=audioCtx.createGain(); musicGain.gain.value=0.05; musicGain.connect(masterGain);
        }catch(e){ /* audio disabled */ }
      }
      function sfx(freq=440, dur=0.06, type='square', vol=0.25){
        if(!audioCtx || muteChk.checked) return;
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type=type; o.frequency.value=freq;
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
        o.connect(g); g.connect(masterGain);
        o.start(); o.stop(audioCtx.currentTime+dur);
      }
      const thwack=()=>{ sfx(140,.07,'square',.35); sfx(60,.08,'sawtooth',.25); };
      const snip=()=> sfx(900,.03,'triangle',.12);
      const coin=()=> sfx(1200,.12,'square',.2);
      function fanfare(){ sfx(440,.12,'square',.25); setTimeout(()=>sfx(660,.14,'square',.25),100); setTimeout(()=>sfx(880,.18,'square',.25),220); }
      function toggleMusic(on){
        if(!audioCtx) return;
        if(on){
          if(musicOsc) return;
          musicOsc=audioCtx.createOscillator();
          musicOsc.type='triangle';
          musicOsc.frequency.value=90;
          musicOsc.connect(musicGain);
          musicOsc.start();
        } else { try{ musicOsc&&musicOsc.stop(); }catch(e){} musicOsc=null; }
      }

      /* ===== Input state ===== */
      const keys=new Set();
      const mouse={x:0,y:0,down:false};
      const touch={leftId:null,rightId:null,left:null,right:null};

      /* ===== Game state ===== */
      let state=null;
      let last=performance.now();
      let running=false;
      let animId=0;
      let highScore = parseInt(storage.getItem('tyson_highscore')||'0',10);

      /* ===== Particles & Taunts ===== */
      function spawnConfetti(x,y,count=20){
        state.particles = state.particles || [];
        for (let i=0;i<count;i++){
          state.particles.push({x,y,vx:Math.random()*4-2,vy:Math.random()*-3-0.5,g:0.08+Math.random()*0.05,life:40+Math.floor(Math.random()*20),size:3+Math.random()*3,color:`hsl(${Math.random()*360},100%,60%)`});
        }
      }
      function updateParticles(){ if(!state.particles) return; for(const p of state.particles){ p.life--; p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; } state.particles=state.particles.filter(p=>p.life>0); }
      function drawParticles(){ if(!state.particles) return; for(const p of state.particles){ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); } }
      const baseTaunts=["Oof!","Bat-tastic!","Scissor Fail!","Tyson Wins!","Snip Snip â€” No!","Bonk!","KO!","Clutch!","Outta here!","Sit down!"];
      const spicyTaunts=["Bring a bat next time!","Detention ðŸ›Žï¸","Tyson just yeeted your GPA!","Scissors? Bold.","Bat > âœ‚ï¸","Clang!","Snipped your hopes!","Not today, kid!","Curriculum Adjusted!"];
      const unhingedTaunts=["Massacre Mode Activated!","WELCOME TO BAT SCHOOL","Homework: Duck.","Legendary Bonk!","Certified Batness","Physics Lesson: Momentum","Clipâ€¦ Clapped.","Principal Approved!"];
      function pickTaunt(){ const k=state.playerKills||0; if(k>20) return unhingedTaunts[Math.floor(Math.random()*unhingedTaunts.length)]; if(k>8) return spicyTaunts[Math.floor(Math.random()*spicyTaunts.length)]; return baseTaunts[Math.floor(Math.random()*baseTaunts.length)]; }
      function addTaunt(x,y){ state.floats=state.floats||[]; state.floats.push({text:pickTaunt(),x,y,life:60}); }
      function updateFloats(){ if(!state.floats) return; for(const f of state.floats){ f.y-=0.6; f.life--; } state.floats=state.floats.filter(f=>f.life>0); }
      function drawFloats(){ if(!state.floats) return; ctx.font='700 18px system-ui, -apple-system, Segoe UI'; ctx.textBaseline='bottom'; ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=3; for(const f of state.floats){ ctx.globalAlpha=Math.max(0,f.life/60); ctx.strokeText(f.text,f.x+1,f.y+1); ctx.fillStyle='#fff'; ctx.fillText(f.text,f.x,f.y); ctx.globalAlpha=1; } }

      /* ===== Epstone hunting ===== */
      let epRetargetTimer = 0;
      function acquireEpTarget(){
        const ep=state.epstone; if(!ep) return null;
        if(!state.enemies || state.enemies.length===0) return {x:state.player.x,y:state.player.y,type:'player'};
        let best=null,bestD2=Infinity;
        for(const e of state.enemies){ const dx=e.x-ep.x,dy=e.y-ep.y,d2=dx*dx+dy*dy; if(d2<bestD2){best=e;bestD2=d2;} }
        return best?{x:best.x,y:best.y,type:'hs'}:null;
      }
      function steerEpstoneToward(target,dt){
        const ep=state.epstone; if(!ep||!target) return;
        let [nx,ny]=norm(target.x-ep.x,target.y-ep.y);
        const look=40+ep.speed*0.25; const future={x:ep.x+nx*look,y:ep.y+ny*look,r:ep.r};
        for(const r of state.obstacles){ if(circleRectCollide(future,r)){ const cx=clamp(future.x,r.x,r.x+r.w), cy=clamp(future.y,r.y,r.y+r.h); const [px,py]=norm(future.x-cx,future.y-cy); nx+=px*2; ny+=py*2; } }
        [nx,ny]=norm(nx,ny); ep.x+=nx*ep.speed*dt; ep.y+=ny*ep.speed*dt;
      }

      /* ===== Wild mode ===== */
      function triggerWildEvent(){
        if(!state.crazy) return;
        const roll=Math.random();
        if(roll<.33){
          state.enemies.forEach(e=>e.speedMul=0.7+Math.random()*0.8);
          state.wildTimers.push({t:6,type:'speedReset'});
          addTaunt(state.player.x,state.player.y-30);
        } else if(roll<.66){
          for(let i=0;i<8;i++){
            state.meteors.push({x:Math.random()*state.W,y:-40-Math.random()*200,vy:200+Math.random()*160,w:14+Math.random()*12,h:28+Math.random()*20,t:5});
          }
          addTaunt(state.player.x,state.player.y-30);
        } else {
          const picks=Math.min(6,state.enemies.length);
          for(let i=0;i<picks;i++){
            const e=state.enemies[Math.floor(Math.random()*state.enemies.length)];
            if(!e) break;
            state.enemies.push({x:e.x+randRange(-20,20),y:e.y+randRange(-20,20),r:e.r,speed:e.speed,hp:e.hp,elite:false,disarmed:false,knockT:0,knockVx:0,knockVy:0,touchCd:0,speedMul:1});
          }
          spawnConfetti(state.player.x,state.player.y,30);
        }
        state.nextWildIn=18+Math.random()*12;
      }

      /* ===== Canvas/level ===== */
      function resize(){
        const dpr=window.devicePixelRatio||1;
        const w=Math.min(wrap.clientWidth,1100);
        const h=Math.min(Math.max(wrap.clientHeight,560),820);
        canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
        canvas.style.width=w+'px'; canvas.style.height=h+'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
        if(state) draw();
      }
      window.addEventListener('resize',resize);

      function createLevel(){
        const W=parseInt(canvas.style.width)||canvas.width;
        const H=parseInt(canvas.style.height)||canvas.height;
        const margin=24;
        const obstacles=[];
        const deskW=120,deskH=60,gapX=40,gapY=40,rows=2,cols=3;
        const sx=(W-(cols*deskW+(cols-1)*gapX))/2;
        const sy=(H-(rows*deskH+(rows-1)*gapY))/2;
        for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) obstacles.push({x:sx+c*(deskW+gapX),y:sy+r*(deskH+gapY),w:deskW,h:deskH});
        return {W,H,room:{w:W,h:H,margin},obstacles};
      }

      function createGame(){
        const {W,H,room,obstacles}=createLevel();
        const player={ x:W*0.5,y:H*0.85,r:16, speed:230,aim:0,hp:3,iFrames:0, swing:{active:false,t:0,duration:0.24,arc:1.9,range:72,cooldown:0}, power:{flameT:0,shrinkT:0} };
        const difficulty=clamp(parseInt(diffSel?.value||'2')-1,0,2);
        const enemyCount=[24,30,36][difficulty];
        const enemySpeed=[85,105,125][difficulty];
        const epSpeed=Math.round(enemySpeed*0.85);
        const enemies=[];
        const spawnR=Math.min(W,H)*0.42;
        for(let i=0;i<enemyCount;i++){ const a=i/enemyCount*Math.PI*2; const x=W*0.5+Math.cos(a)*spawnR; const y=H*0.45+Math.sin(a)*spawnR*0.7; enemies.push({x,y,r:14,speed:enemySpeed,hp:1,elite:false,disarmed:false,knockT:0,knockVx:0,knockVy:0,touchCd:0,speedMul:1}); }
        /* 5 elite Olgas (blue/white, +1 HP, slower, bigger) */
        const buffCount=Math.min(5,enemies.length);
        const picks=new Set(); while(picks.size<buffCount) picks.add(Math.floor(Math.random()*enemies.length));
        for(const idx of picks){ const e=enemies[idx]; e.elite=true; e.hp=2; e.r=18; e.speed=Math.round(e.speed*0.85); }

        state={ W,H,room,obstacles,player,enemies, enemySpeed,epSpeed, score:0,t:0, particles:[], powerUps:[], epstone:null, epPhase:1, epTarget:null, playerKills:0,epKills:0, shake:0, floats:[], clones:[], meteors:[], crazy:!!crazyChk.checked, nextWildIn:12+Math.random()*8, wildTimers:[] };
        epRetargetTimer=0;

        running=false;
        updateHUD(); hide(endOverlay); show(startOverlay); draw();
      }

      function spawnPowerUp(x,y,type){ state.powerUps.push({type,x,y,r:10,t:0,taken:false}); }
      function spawnEpstone(){
        const x=state.W*0.5, y=state.H*0.25;
        state.epstone={ x,y,r:28,hp:20,speed:state.epSpeed,disarmed:false, knockT:0,knockVx:0,knockVy:0, batAngle:0,batSpeed:3.2,batArc:1.1,batRange:95, phase:1, orbiters:[] };
        state.epTarget=acquireEpTarget();
      }

      function start(){
        running=true; last=performance.now(); hide(startOverlay); cancelAnimationFrame(animId); animId=requestAnimationFrame(loop);
        // Only start music after interaction if needed â€” safe to skip on autoplay-restricted browsers
        // ensureAudio(); toggleMusic(!muteChk.checked);
      }
      function stop(win){
        running=false; toggleMusic(false);
        endTitle.textContent= win ? 'You kept control!' : 'Overrun!';
        endMsg.textContent = win ? `Score: ${state.score} â€¢ Time: ${Math.floor(state.t)}s â€¢ Kills (You/Ep): ${state.playerKills}/${state.epKills}` : `Use desks to funnel the swarm. Time swings through the thickest part.`;
        if(state.score>highScore){ highScore=state.score; storage.setItem('tyson_highscore',String(highScore)); fanfare(); }
        bestEl.textContent=highScore;
        const txt=encodeURIComponent(`I scored ${state.score} in Tyson vs HS! (${state.playerKills} KOs) #TysonBat #CanvasGame`);
        shareBtn.href='https://twitter.com/intent/tweet?text='+txt;
        show(endOverlay);
      }
      function reset(){ createGame(); draw(); runCountdown(); }

      /* Clones */
      function spawnClone(){ const c={x:state.player.x,y:state.player.y,r:10,speed:200,life:10}; state.clones.push(c); }
      function updateClones(dt){
        const alive=[];
        for(const c of state.clones){
          c.life-=dt;
          let best=null,bestD2=Infinity;
          for(const e of state.enemies){ const dx=e.x-c.x,dy=e.y-c.y,d2=dx*dx+dy*dy; if(d2<bestD2){best=e;bestD2=d2;} }
          if(best){ const [nx,ny]=norm(best.x-c.x,best.y-c.y); c.x+=nx*c.speed*dt; c.y+=ny*c.speed*dt; const er=best.r*(state.player.power.shrinkT>0?0.6:1); const dx=best.x-c.x,dy=best.y-c.y; if(dx*dx+dy*dy<(er+c.r)*(er+c.r)){ best.hp-=1; spawnConfetti(best.x,best.y,10); if(best.hp<=0){ best.disarmed=true; state.score+=80; state.playerKills++; addTaunt(best.x,best.y-10); addShake(0.1); } } }
          if(c.life>0) alive.push(c);
        }
        state.clones=alive;
      }

      function trySwing(){ const p=state.player; if(p.swing.active||p.swing.cooldown>0) return; p.swing.active=true; p.swing.t=0; thwack(); }

      /* Input */
      function handleInput(dt){
        const p=state.player; let vx=0,vy=0;
        if(keys.has('ArrowLeft')||keys.has('a')) vx-=1;
        if(keys.has('ArrowRight')||keys.has('d')) vx+=1;
        if(keys.has('ArrowUp')||keys.has('w')) vy-=1;
        if(keys.has('ArrowDown')||keys.has('s')) vy+=1;
        if(touch.left){ const {start,cur}=touch.left; const dx=cur.x-start.x,dy=cur.y-start.y; const [nx,ny]=norm(dx,dy); const mag=Math.min(1,len(dx,dy)/48); vx+=nx*mag; vy+=ny*mag; }
        const [nx,ny]=norm(vx,vy); p.x+=nx*p.speed*dt; p.y+=ny*p.speed*dt;
        const margin=state.room.margin+p.r; p.x=clamp(p.x,margin,state.W-margin); p.y=clamp(p.y,margin,state.H-margin);
        const pc={x:p.x,y:p.y,r:p.r};
        for(const r of state.obstacles){ if(circleRectCollide(pc,r)){ const cx=clamp(pc.x,r.x,r.x+r.w), cy=clamp(pc.y,r.y,r.y+r.h); const dx=pc.x-cx,dy=pc.y-cy; if(Math.abs(dx)>Math.abs(dy)) p.y+=Math.sign(dy)*(pc.r-Math.abs(dy)+0.1); else p.x+=Math.sign(dx)*(pc.r-Math.abs(dx)+0.1); pc.x=p.x; pc.y=p.y; } }
        if(touch.right){ const {center,cur}=touch.right; p.aim=Math.atan2(cur.y-center.y,cur.x-center.x); } else { const rect=canvas.getBoundingClientRect(); const mx=mouse.x-rect.left,my=mouse.y-rect.top; p.aim=Math.atan2(my-p.y,mx-p.x); }
        if(p.swing.cooldown>0) p.swing.cooldown=Math.max(0,p.swing.cooldown-dt);
        if(p.swing.active){ p.swing.t+=dt; if(p.swing.t>=p.swing.duration){ p.swing.active=false; p.swing.t=0; p.swing.cooldown=0.18; } }
      }

      /* Update */
      function update(dt){
        state.t+=dt;
        const p=state.player;
        if(p.power.flameT>0) p.power.flameT=Math.max(0,p.power.flameT-dt);
        if(p.power.shrinkT>0) p.power.shrinkT=Math.max(0,p.power.shrinkT-dt);
        if(p.iFrames>0) p.iFrames=Math.max(0,p.iFrames-dt);

        state.crazy=!!crazyChk.checked; state.nextWildIn-=dt; if(state.crazy && state.nextWildIn<=0) triggerWildEvent();
        const newTimers=[]; for(const tmr of state.wildTimers){ tmr.t-=dt; if(tmr.t>0) newTimers.push(tmr); else if(tmr.type==='speedReset'){ state.enemies.forEach(e=>e.speedMul=1); } } state.wildTimers=newTimers;

        if(!state.epstone && state.playerKills>=10) spawnEpstone();

        for(const e of state.enemies){
          if(e.disarmed) continue;
          const er=e.r*(p.power.shrinkT>0?0.6:1);
          if(e.knockT>0){ e.x+=e.knockVx*dt; e.y+=e.knockVy*dt; e.knockT-=dt; }
          else { const [nx,ny]=norm(p.x-e.x,p.y-e.y); e.x+=nx*(e.speed*(e.speedMul||1))*dt; e.y+=ny*(e.speed*(e.speedMul||1))*dt; }
          const cc={x:e.x,y:e.y,r:er};
          for(const r of state.obstacles){ if(circleRectCollide(cc,r)){ const cx=clamp(cc.x,r.x,r.x+r.w), cy=clamp(cc.y,r.y,r.y+r.h); const dx=cc.x-cx,dy=cc.y-cy; if(Math.abs(dx)>Math.abs(dy)) e.y+=Math.sign(dy)*(cc.r-Math.abs(dy)+0.1); else e.x+=Math.sign(dx)*(cc.r-Math.abs(dx)+0.1); cc.x=e.x; cc.y=e.y; } }
          if(e.touchCd>0) e.touchCd-=dt;
          const dx=e.x-p.x,dy=e.y-p.y;
          if(dx*dx+dy*dy<(er+p.r)*(er+p.r)){ if(e.touchCd<=0 && p.iFrames<=0){ p.hp-=1; p.iFrames=1.2; e.touchCd=0.7; addShake(0.18); snip(); if(p.hp<=0){ updateHUD(); stop(false); return; } } }
        }

        /* Meteors */
        const aliveM=[]; for(const m of state.meteors){ m.y+=m.vy*dt; m.t-=dt;
          for(const e of state.enemies){ if(e.disarmed) continue; const er=e.r*(p.power.shrinkT>0?0.6:1); if(e.x>m.x-m.w && e.x<m.x+m.w && e.y>m.y-m.h && e.y<m.y+m.h){ e.hp=0; e.disarmed=true; state.playerKills++; state.score+=50; spawnConfetti(e.x,e.y,12); addTaunt(e.x,e.y-10); } }
          if(p.x>m.x-m.w && p.x<m.x+m.w && p.y>m.y-m.h && p.y<m.y+m.h){ if(p.iFrames<=0){ p.hp-=1; p.iFrames=1.0; addShake(0.25); } }
          if(m.y<state.H+60 && m.t>0) aliveM.push(m);
        } state.meteors=aliveM;

        /* Epstone */
        if(state.epstone && !state.epstone.disarmed){
          const ep=state.epstone;
          if(ep.phase===1 && ep.hp<=12){ ep.phase=2; state.epPhase=2; ep.batSpeed=3.8; ep.batArc=1.25; ep.orbiters=[]; for(let i=0;i<4;i++) ep.orbiters.push({ang:i*Math.PI/2,rad:ep.batRange*0.7}); }
          epRetargetTimer-=dt; if(epRetargetTimer<=0){ epRetargetTimer=0.35; state.epTarget=acquireEpTarget()||{x:state.W*0.5,y:state.H*0.5,type:'center'}; }
          if(ep.knockT>0){ ep.x+=ep.knockVx*dt; ep.y+=ep.knockVy*dt; ep.knockT-=dt; } else { steerEpstoneToward(state.epTarget,dt); }
          const cc={x:ep.x,y:ep.y,r:ep.r};
          for(const r of state.obstacles){ if(circleRectCollide(cc,r)){ const cx=clamp(cc.x,r.x,r.x+r.w), cy=clamp(cc.y,r.y,r.y+r.h); const dx=cc.x-cx,dy=cc.y-cy; if(Math.abs(dx)>Math.abs(dy)) ep.y+=Math.sign(dy)*(cc.r-Math.abs(dy)+0.1); else ep.x+=Math.sign(dx)*(cc.r-Math.abs(dx)+0.1); cc.x=ep.x; cc.y=ep.y; } }
          ep.batAngle=(ep.batAngle+ep.batSpeed*dt)%(Math.PI*2);
          for(const e of state.enemies){ if(e.disarmed) continue; if(withinArc(e.x,e.y,ep.x,ep.y,ep.batAngle,ep.batArc,ep.batRange)){ e.hp-=1; if(e.hp<=0){ e.disarmed=true; state.epKills++; addShake(0.12); spawnConfetti(e.x,e.y,10); } else { const [nx,ny]=norm(e.x-ep.x,e.y-ep.y); e.knockVx=nx*220; e.knockVy=ny*220; e.knockT=0.1; } } }
          if(ep.phase>=2){ for(const o of ep.orbiters){ o.ang+=2.2*dt; const ox=ep.x+Math.cos(o.ang)*o.rad, oy=ep.y+Math.sin(o.ang)*o.rad; const dx=ox-state.player.x,dy=oy-state.player.y; if(dx*dx+dy*dy<(state.player.r+10)*(state.player.r+10)){ if(state.player.iFrames<=0){ state.player.hp-=1; state.player.iFrames=1.0; addShake(0.2); } } for(const e of state.enemies){ if(e.disarmed) continue; const ex=ox-e.x,ey=oy-e.y; const er=e.r*(state.player.power.shrinkT>0?0.6:1); if(ex*ex+ey*ey<(er+8)*(er+8)){ e.hp-=1; if(e.hp<=0){ e.disarmed=true; state.epKills++; spawnConfetti(e.x,e.y,8); } } } }
          if(withinArc(p.x,p.y,ep.x,ep.y,ep.batAngle,ep.batArc,ep.batRange+p.r)){ if(p.iFrames<=0){ p.hp-=1; p.iFrames=1.0; addShake(0.18); if(p.hp<=0){ updateHUD(); stop(false); return; } } }
        }

        /* Player swing */
        if(p.swing.active){
          const prog=p.swing.t/p.swing.duration, base=p.aim-p.swing.arc*0.5, cur=base+p.swing.arc*prog, flame=p.power.flameT>0;
          for(const e of state.enemies){
            if(e.disarmed) continue;
            const direct=withinArc(e.x,e.y,p.x,p.y,cur,0.55,p.swing.range);
            const splash=flame && !direct && withinArc(e.x,e.y,p.x,p.y,cur,1.2,p.swing.range+10);
            if(direct||splash){
              e.hp-=1; spawnConfetti(e.x,e.y,8);
              if(e.hp<=0){
                e.disarmed=true; state.score+=100; state.playerKills++; addShake(0.12); addTaunt(e.x,e.y-10);
                if(e.elite && Math.random()<0.6){ const kinds=['flame','shrink','clone']; spawnPowerUp(e.x,e.y,kinds[Math.floor(Math.random()*kinds.length)]); }
              } else { const [nx,ny]=norm(e.x-p.x,e.y-p.y); const k=direct?260:200; e.knockVx=nx*k; e.knockVy=ny*k; e.knockT=direct?0.12:0.10; }
            }
          }
          if(state.epstone && !state.epstone.disarmed){
            const ep=state.epstone;
            const hit=withinArc(ep.x,ep.y,p.x,p.y,cur,0.55,p.swing.range);
            const glance=flame && !hit && withinArc(ep.x,ep.y,p.x,p.y,cur,1.2,p.swing.range+10);
            if(hit||glance){
              ep.hp-=1; addShake(0.08); spawnConfetti(ep.x,ep.y,6);
              if(ep.hp<=0){ ep.disarmed=true; state.score+=500; addShake(0.2); spawnConfetti(ep.x,ep.y,30); }
              else { const [nx,ny]=norm(ep.x-p.x,ep.y-p.y); const k=hit?240:200; ep.knockVx=nx*k; ep.knockVy=ny*k; ep.knockT=0.15; }
            }
          }
        }

        /* Power-ups */
        for(const pu of state.powerUps){ if(pu.taken) continue; pu.t+=dt; const dx=pu.x-p.x,dy=pu.y-p.y; if(dx*dx+dy*dy<(pu.r+p.r)*(pu.r+p.r)){ pu.taken=true; coin(); if(pu.type==='flame') p.power.flameT=Math.max(p.power.flameT,10); if(pu.type==='shrink') p.power.shrinkT=Math.max(p.power.shrinkT,8); if(pu.type==='clone') spawnClone(); } }
        state.powerUps=state.powerUps.filter(pu=>!pu.taken);

        state.enemies=state.enemies.filter(e=>!e.disarmed);
        state.shake=Math.max(0,state.shake-dt*4);
        updateParticles(); updateFloats(); updateClones(dt);

        if(state.enemies.length===0){
          if(state.epstone){ if(state.epstone.disarmed || state.epKills<=state.playerKills){ updateHUD(); stop(true); return; } }
          else { updateHUD(); stop(true); return; }
        }
        updateHUD();
      }

      /* Draw */
      function draw(){
        if(!state) return; const {W,H}=state;
        ctx.clearRect(0,0,W,H);
        ctx.save(); if(state.shake>0) ctx.translate(randRange(-1,1)*state.shake*6,randRange(-1,1)*state.shake*6);

        const hue=(state.epPhase>=2)?((Date.now()/20)%360):215;
        ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,W,H);
        ctx.strokeStyle=`hsl(${hue},35%,22%)`; ctx.lineWidth=1;
        for(let x=20;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
        for(let y=20;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

        ctx.strokeStyle='#3b82f6'; ctx.lineWidth=3; ctx.strokeRect(state.room.margin,state.room.margin,W-state.room.margin*2,H-state.room.margin*2);

        ctx.fillStyle='#1e293b'; ctx.strokeStyle='#475569'; ctx.lineWidth=2;
        for(const r of state.obstacles){ ctx.fillRect(r.x,r.y,r.w,r.h); ctx.strokeRect(r.x,r.y,r.w,r.h); }

        ctx.fillStyle='#fb923c'; for(const m of state.meteors){ ctx.fillRect(m.x-m.w/2,m.y-m.h/2,m.w,m.h); }

        for(const pu of state.powerUps){ const bob=Math.sin(pu.t*4)*4; ctx.beginPath(); ctx.arc(pu.x,pu.y+bob,pu.r,0,Math.PI*2); ctx.fillStyle=(pu.type==='flame')?'#f59e0b':(pu.type==='shrink'?'#34d399':'#93c5fd'); ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fde68a'; ctx.stroke(); }

        drawParticles(); drawFloats();

        for(const c of state.clones){ ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fillStyle='#60a5fa'; ctx.fill(); ctx.strokeStyle='#1d4ed8'; ctx.lineWidth=2; ctx.stroke(); }

        for(const e of state.enemies){
          const er=e.r*(state.player.power.shrinkT>0?0.6:1);
          if(e.elite){ const grd=ctx.createRadialGradient(e.x-4,e.y-4,4,e.x,e.y,er+2); grd.addColorStop(0,'#e0f2fe'); grd.addColorStop(1,'#60a5fa'); ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(e.x,e.y,er,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#e2e8f0'; ctx.stroke(); }
          else { ctx.fillStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(e.x,e.y,er,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#334155'; ctx.stroke(); }
        }

        if(state.epstone){
          const ep=state.epstone;
          ctx.save(); ctx.shadowBlur=18; ctx.shadowColor='#a855f7'; ctx.fillStyle='rgba(168,85,247,0.9)'; ctx.beginPath(); ctx.arc(ep.x,ep.y,ep.r,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; ctx.restore();
          ctx.lineWidth=3; ctx.strokeStyle='#6d28d9'; ctx.beginPath(); ctx.arc(ep.x,ep.y,ep.r,0,Math.PI*2); ctx.stroke();
          ctx.save(); ctx.translate(ep.x,ep.y); ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,ep.batRange,ep.batAngle-ep.batArc/2,ep.batAngle+ep.batArc/2); ctx.closePath(); ctx.fillStyle='rgba(168,85,247,0.25)'; ctx.fill(); ctx.restore();
          if(ep.phase>=2){ for(const o of ep.orbiters){ const ox=ep.x+Math.cos(o.ang)*o.rad, oy=ep.y+Math.sin(o.ang)*o.rad; ctx.beginPath(); ctx.arc(ox,oy,8,0,Math.PI*2); ctx.fillStyle='#a78bfa'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#6d28d9'; ctx.stroke(); } }
        }

        const p=state.player;
        if(p.power.flameT>0){ ctx.save(); ctx.shadowBlur=10; ctx.shadowColor='#facc15'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+10,0,Math.PI*2); ctx.strokeStyle='#facc15'; ctx.lineWidth=3; ctx.stroke(); ctx.restore(); }
        if(p.power.shrinkT>0){ ctx.save(); ctx.globalAlpha=.35; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+16,0,Math.PI*2); ctx.fillStyle='#34d399'; ctx.fill(); ctx.globalAlpha=1; ctx.restore(); }
        if(p.swing.active){ const prog=p.swing.t/p.swing.duration, start=p.aim-p.swing.arc*0.5, cur=start+p.swing.arc*prog; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.arc(p.x,p.y,p.swing.range,start,cur); ctx.closePath(); ctx.fillStyle='rgba(250,204,21,0.25)'; ctx.fill(); }
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='#22c55e'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#065f46'; ctx.stroke();

        ctx.restore();
      }

      function updateHUD(){
        hpEl.textContent=state.player.hp;
        enemiesEl.textContent=state.enemies.length;
        scoreEl.textContent=state.score;
        timeEl.textContent=`${Math.floor(state.t)}s`;
        flameEl.textContent= state.player.power.flameT>0 ? `${Math.ceil(state.player.power.flameT)}s` : (state.player.power.shrinkT>0 ? `Shrink ${Math.ceil(state.player.power.shrinkT)}s` : '0s');
        killsEl.textContent=`${state.playerKills}/${state.epKills}`;
        bestEl.textContent=highScore;
      }

      function loop(ts){
        if(!running) return;
        const dt=Math.min((ts-last)/1000,0.033);
        last=ts;
        handleInput(dt); update(dt); draw();
        animId=requestAnimationFrame(loop);
      }

      /* ===== Countdown + boot ===== */
      function runCountdown(){
        show(startOverlay);
        // Pick integer 1â€“3 seconds
        let remaining = 1 + Math.floor(Math.random()*3);
        countNum.textContent = String(remaining);
        countLabel.textContent = 'Starting inâ€¦';

        const tick = () => {
          remaining -= 1;
          if(remaining <= 0){
            hide(startOverlay);
            start();
          } else {
            countNum.textContent = String(remaining);
            setTimeout(tick, 1000);
          }
        };
        setTimeout(tick, 1000);
      }

      /* Listeners */
      window.addEventListener('keydown',(e)=>{ ensureAudio(); const k=e.key.toLowerCase(); if(['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(k)) keys.add(k); if(k===' '){ e.preventDefault(); trySwing(); } });
      window.addEventListener('keyup',(e)=>{ keys.delete(e.key.toLowerCase()); });
      canvas.addEventListener('mousemove',(e)=>{ mouse.x=e.clientX; mouse.y=e.clientY; });
      canvas.addEventListener('mousedown',()=>{ ensureAudio(); if(!muteChk.checked) thwack(); trySwing(); });
      window.addEventListener('mouseup',()=>{ mouse.down=false; });

      function canvasPos(touchEvent,t){ const rect=canvas.getBoundingClientRect(); return {x:t.clientX-rect.left,y:t.clientY-rect.top}; }
      canvas.addEventListener('touchstart',(e)=>{ ensureAudio(); e.preventDefault(); for(const t of e.changedTouches){ const pos=canvasPos(e,t); const left=pos.x<canvas.clientWidth/2; if(left && touch.leftId===null){ touch.leftId=t.identifier; touch.left={start:pos,cur:pos}; } else if(!left && touch.rightId===null){ touch.rightId=t.identifier; touch.right={center:pos,cur:pos}; trySwing(); } } },{passive:false});
      canvas.addEventListener('touchmove',(e)=>{ e.preventDefault(); for(const t of e.changedTouches){ const pos=canvasPos(e,t); if(t.identifier===touch.leftId && touch.left) touch.left.cur=pos; if(t.identifier===touch.rightId && touch.right) touch.right.cur=pos; } },{passive:false});
      canvas.addEventListener('touchend',(e)=>{ e.preventDefault(); for(const t of e.changedTouches){ if(t.identifier===touch.leftId){ touch.leftId=null; touch.left=null; } if(t.identifier===touch.rightId){ touch.rightId=null; touch.right=null; } } },{passive:false});

      if(resetBtn) resetBtn.addEventListener('click', reset);
      if(diffSel)  diffSel.addEventListener('change', ()=>{ createGame(); draw(); });
      if(muteChk)  muteChk.addEventListener('change', ()=>{ if(muteChk.checked) toggleMusic(false); else { ensureAudio(); toggleMusic(true);} });
      if(restartBtn) restartBtn.addEventListener('click', ()=>location.reload());
      if(againBtn)   againBtn.addEventListener('click', ()=>location.reload());

      /* Install no-op startGame (not used now) */
      window.startGame = ()=>{}; // countdown will auto-start

      /* Boot */
      function resize(){ const dpr=window.devicePixelRatio||1; const w=Math.min(wrap.clientWidth,1100); const h=Math.min(Math.max(wrap.clientHeight,560),820); canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr); canvas.style.width=w+'px'; canvas.style.height=h+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); if(state) draw(); }
      window.addEventListener('resize',resize);
      resize();
      createGame();
      bestEl.textContent = highScore;
      runCountdown();
    })();
  });
  </script>
</body>
</html>