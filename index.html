<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Tyson-with-a-bat-vs.-30-HS-with-a-scissor</title>
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg:#0b1220;
Â  Â  Â  --panel:#0f172a;
Â  Â  Â  --panel2:#1e293b;
Â  Â  Â  --border:#334155;
Â  Â  Â  --text:#e5e7eb;
Â  Â  Â  --muted:#94a3b8;
Â  Â  Â  --accent:#3b82f6;
Â  Â  Â  --emerald:#22c55e;
Â  Â  Â  --warn:#facc15;
Â  Â  Â  --danger:#ef4444;
Â  Â  Â  --orange:#fb923c;
Â  Â  Â  --epstone:#a855f7;
Â  Â  }
Â  Â  html,body {
Â  Â  Â  height:100%;
Â  Â  Â  margin:0;
Â  Â  Â  background:var(--bg);
Â  Â  Â  color:var(--text);
Â  Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .wrap {
Â  Â  Â  position:relative;
Â  Â  Â  height:92vh;
Â  Â  Â  min-height:560px;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  user-select:none;
Â  Â  }
Â  Â  canvas {
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:12px;
Â  Â  Â  touch-action:none;
Â  Â  Â  background:#07101f;
Â  Â  }
Â  Â  .hud {
Â  Â  Â  position:absolute;
Â  Â  Â  top:12px;
Â  Â  Â  left:12px;
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:8px;
Â  Â  }
Â  Â  .card {
Â  Â  Â  background:rgba(15,23,42,.7);
Â  Â  Â  backdrop-filter:blur(6px);
Â  Â  Â  border-radius:12px;
Â  Â  Â  padding:8px 12px;
Â  Â  Â  box-shadow:0 6px 18px rgba(0,0,0,.25);
Â  Â  }
Â  Â  .grid {
Â  Â  Â  display:grid;
Â  Â  Â  grid-template-columns:repeat(7,minmax(0,1fr));
Â  Â  Â  gap:8px;
Â  Â  }
Â  Â  .tile { background:rgba(15,23,42,.7); border-radius:10px; padding:8px 10px; }
Â  Â  .muted { font-size:12px; color:var(--muted); }
Â  Â  .big { font-weight:700; font-size:20px; }

Â  Â  .controls {
Â  Â  Â  position:absolute;
Â  Â  Â  top:12px;
Â  Â  Â  right:12px;
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:8px;
Â  Â  Â  align-items:flex-end;
Â  Â  }
Â  Â  .row { display:flex; gap:8px; align-items:center; }
Â  Â  select,button,input[type="checkbox"] {
Â  Â  Â  background:rgba(15,23,42,.8);
Â  Â  Â  color:var(--text);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:10px;
Â  Â  Â  padding:8px 10px;
Â  Â  Â  font-weight:600;
Â  Â  }
Â  Â  label.switch { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); background:rgba(15,23,42,.6); border:1px solid var(--border); padding:6px 10px; border-radius:10px; }
Â  Â  button.start { background:var(--emerald); color:var(--bg); border:0; }
Â  Â  button.reset { background:#fbbf24; color:#111827; border:0; }
Â  Â  button.play { background:#38bdf8; color:#0b141e; border:0; }

Â  Â  .overlay {
Â  Â  Â  position:absolute;
Â  Â  Â  inset:0;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  }
Â  Â  .panel {
Â  Â  Â  max-width:740px;
Â  Â  Â  background:rgba(15,23,42,.88);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:18px;
Â  Â  Â  padding:20px;
Â  Â  Â  text-align:center;
Â  Â  Â  box-shadow:0 12px 30px rgba(0,0,0,.35);
Â  Â  }
Â  Â  .panel .actions { display:flex; gap:10px; justify-content:center; margin-top:10px; }
Â  Â  .hint {
Â  Â  Â  position:absolute;
Â  Â  Â  bottom:8px;
Â  Â  Â  left:50%;
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  color:var(--muted);
Â  Â  Â  font-size:12px;
Â  Â  Â  background:rgba(2,6,23,.6);
Â  Â  Â  padding:6px 10px;
Â  Â  Â  border-radius:999px;
Â  Â  }
Â  Â  .hide { display:none; }

Â  Â  .hud, .controls { z-index:10; }
Â  Â  .overlay { z-index:50; }

Â  Â  .countNum {
Â  Â  Â  font-size:64px;
Â  Â  Â  font-weight:900;
Â  Â  Â  letter-spacing:0.03em;
Â  Â  Â  margin:0.2rem 0 0.25rem;
Â  Â  }
Â  Â  .countSub {
Â  Â  Â  color:#cbd5e1;
Â  Â  Â  margin:0 0 0.6rem;
Â  Â  }
Â  Â Â 
Â  Â  /* Responsive HUD for mobile */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  .grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(4, minmax(0, 1fr));
Â  Â  Â  Â  }
Â  Â  }
Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  .grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(3, minmax(0, 1fr));
Â  Â  Â  Â  }
Â  Â  Â  Â  .big { font-size: 16px; }
Â  Â  Â  Â  .controls { display: none; } /* Hide desktop controls on small screens */
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="wrap" id="wrap">
Â  Â  <canvas id="game"></canvas>

Â  Â  <div id="errOverlay" class="overlay hide">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <div style="font-weight:800;font-size:20px;margin-bottom:6px">Script error</div>
Â  Â  Â  Â  <pre id="errMsg" style="white-space:pre-wrap;text-align:left;color:#e5e7eb;margin:0"></pre>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="hud">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="muted" style="text-transform:uppercase;letter-spacing:.08em">Mode</div>
Â  Â  Â  Â  <div class="big">Tyson-with-a-bat vs. 30 HS (scissors)</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="grid">
Â  Â  Â  Â  <div class="tile"><div class="muted">HP</div><div class="big" id="hp">3</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Enemies</div><div class="big" id="enemies">0</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Score</div><div class="big" id="score">0</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Time</div><div class="big" id="time">0s</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Flame</div><div class="big" id="flame">0s</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Kills</div><div class="big" id="kills">0/0</div></div>
Â  Â  Â  Â  <div class="tile"><div class="muted">Best</div><div class="big" id="best">0</div></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="controls">
Â  Â  Â  <div class="row card" style="gap:12px; align-items:center;">
Â  Â  Â  Â  <span class="muted">Difficulty</span>
Â  Â  Â  Â  <select id="diff">
Â  Â  Â  Â  Â  <option value="1">Easy (24)</option>
Â  Â  Â  Â  Â  <option value="2" selected>Normal (30)</option>
Â  Â  Â  Â  Â  <option value="3">Hard (36)</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <label class="switch"><input id="crazy" type="checkbox" /> Wild Mode</label>
Â  Â  Â  Â  <label class="switch"><input id="mute" type="checkbox" /> Mute</label>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button class="play" id="restartBtn" type="button">Restart (reload)</button>
Â  Â  Â  Â  <button class="reset" id="resetBtn" type="button">Reset (in-place)</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="overlay" id="startOverlay">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h1 class="countNum" id="countNum">3</h1>
Â  Â  Â  Â  <div class="countSub" id="countLabel">Starting inâ€¦</div>
Â  Â  Â  Â  <p style="margin:0 0 12px; color:#cbd5e1">
Â  Â  Â  Â  Â  Kite the swarm, use desks as choke points, and time your bat swing.<br>
Â  Â  Â  Â  Â  Elites can drop a <span style="color:var(--warn);font-weight:700">Flame Bat</span>. After 10 kills, beware: a massive purple Epstone will enter the fray!
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="overlay hide" id="endOverlay">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <div id="endTitle" style="font-size:28px;font-weight:800;margin-bottom:8px">Result</div>
Â  Â  Â  Â  <div id="endMsg" style="color:#cbd5e1;margin-bottom:14px">â€”</div>
Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  <button id="againBtn" class="play" type="button">Play Again</button>
Â  Â  Â  Â  Â  <a id="shareBtn" class="play" href="#" target="_blank" style="text-decoration:none;display:inline-block;padding:.6rem 1rem;border-radius:10px;border:0;background:#64748b;color:#0b141e;font-weight:700">Share</a>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="hint">Tip: Strike as the front ranks touch your arc. Elites drop flames â€” grab them for wider, hotter swings. Outscore Epstone to avoid a final showdown!</div>
Â  </div>

Â  <script>
Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  (function(){
Â  Â  Â  const wrap=document.getElementById('wrap');
Â  Â  Â  const canvas=document.getElementById('game');
Â  Â  Â  const ctx=canvas.getContext('2d');

Â  Â  Â  const errOverlay=document.getElementById('errOverlay');
Â  Â  Â  const errMsg=document.getElementById('errMsg');
Â  Â  Â  function showErr(msg){ if(errOverlay&&errMsg){ errMsg.textContent=String(msg); errOverlay.classList.remove('hide'); } }
Â  Â  Â  window.addEventListener('error', e => showErr(e.error?.stack||e.message||e));
Â  Â  Â  window.addEventListener('unhandledrejection', e => showErr(e.reason?.stack||e.reason||e));

Â  Â  Â  const storage = (() => {
Â  Â  Â  Â  try { const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
Â  Â  Â  Â  catch { return {getItem:()=>null,setItem:()=>{},removeItem:()=>{}}; }
Â  Â  Â  })();

Â  Â  Â  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
Â  Â  Â  const len=(x,y)=>Math.hypot(x,y);
Â  Â  Â  const norm=(x,y)=>{const L=Math.hypot(x,y)||1;return[x/L,y/L];};
Â  Â  Â  function withinArc(px,py,cx,cy,ang,arc,range){
Â  Â  Â  Â  const dx=px-cx,dy=py-cy,d=Math.hypot(dx,dy);
Â  Â  Â  Â  if(d>range) return false;
Â  Â  Â  Â  const a=Math.atan2(dy,dx);
Â  Â  Â  Â  const diff=Math.atan2(Math.sin(a-ang),Math.cos(a-ang));
Â  Â  Â  Â  return Math.abs(diff)<=arc*0.5;
Â  Â  Â  }
Â  Â  Â  function circleRectCollide(c,r){
Â  Â  Â  Â  const nx=clamp(c.x,r.x,r.x+r.w);
Â  Â  Â  Â  const ny=clamp(c.y,r.y,r.y+r.h);
Â  Â  Â  Â  const dx=c.x-nx,dy=c.y-ny;
Â  Â  Â  Â  return dx*dx+dy*dy<c.r*c.r;
Â  Â  Â  }
Â  Â  Â  function randRange(a,b){ return a + Math.random()*(b-a); }
Â  Â  Â  function addShake(a){ state.shake = Math.min(1, (state.shake||0) + a); }
Â  Â  Â  const show=(el)=>el && el.classList.remove('hide');
Â  Â  Â  const hide=(el)=>el && el.classList.add('hide');

Â  Â  Â  const hpEl=document.getElementById('hp');
Â  Â  Â  const enemiesEl=document.getElementById('enemies');
Â  Â  Â  const scoreEl=document.getElementById('score');
Â  Â  Â  const timeEl=document.getElementById('time');
Â  Â  Â  const flameEl=document.getElementById('flame');
Â  Â  Â  const killsEl=document.getElementById('kills');
Â  Â  Â  const bestEl=document.getElementById('best');
Â  Â  Â  const diffSel=document.getElementById('diff');
Â  Â  Â  const crazyChk=document.getElementById('crazy');
Â  Â  Â  const muteChk=document.getElementById('mute');
Â  Â  Â  const startOverlay=document.getElementById('startOverlay');
Â  Â  Â  const endOverlay=document.getElementById('endOverlay');
Â  Â  Â  const endTitle=document.getElementById('endTitle');
Â  Â  Â  const endMsg=document.getElementById('endMsg');
Â  Â  Â  const resetBtn=document.getElementById('resetBtn');
Â  Â  Â  const shareBtn=document.getElementById('shareBtn');
Â  Â  Â  const restartBtn=document.getElementById('restartBtn');
Â  Â  Â  const againBtn=document.getElementById('againBtn');
Â  Â  Â  const countNum=document.getElementById('countNum');
Â  Â  Â  const countLabel=document.getElementById('countLabel');

Â  Â  Â  let audioCtx=null, masterGain=null, musicGain=null, musicOsc=null;
Â  Â  Â  function ensureAudio(){
Â  Â  Â  Â  if(audioCtx) return;
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
Â  Â  Â  Â  Â  masterGain=audioCtx.createGain(); masterGain.gain.value=0.12; masterGain.connect(audioCtx.destination);
Â  Â  Â  Â  Â  musicGain=audioCtx.createGain(); musicGain.gain.value=0.05; musicGain.connect(masterGain);
Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function vibrate(pattern) {
Â  Â  Â  Â  Â  if (navigator.vibrate && !muteChk.checked) {
Â  Â  Â  Â  Â  Â  Â  navigator.vibrate(pattern);
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function sfx(freq=440, dur=0.06, type='square', vol=0.25){
Â  Â  Â  Â  if(!audioCtx || muteChk.checked) return;
Â  Â  Â  Â  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
Â  Â  Â  Â  o.type=type; o.frequency.value=freq;
Â  Â  Â  Â  g.gain.setValueAtTime(vol, audioCtx.currentTime);
Â  Â  Â  Â  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
Â  Â  Â  Â  o.connect(g); g.connect(masterGain);
Â  Â  Â  Â  o.start(); o.stop(audioCtx.currentTime+dur);
Â  Â  Â  }
Â  Â  Â  const thwack=()=>{ vibrate(20); sfx(140,.07,'square',.35); sfx(60,.08,'sawtooth',.25); };
Â  Â  Â  const snip=()=> { vibrate(50); sfx(900,.03,'triangle',.12); }
Â  Â  Â  const coin=()=> { vibrate(30); sfx(1200,.12,'square',.2); }
Â  Â  Â  function fanfare(){ sfx(440,.12,'square',.25); setTimeout(()=>sfx(660,.14,'square',.25),100); setTimeout(()=>sfx(880,.18,'square',.25),220); }
Â  Â  Â  function toggleMusic(on){
Â  Â  Â  Â  if(!audioCtx) return;
Â  Â  Â  Â  if(on){
Â  Â  Â  Â  Â  if(musicOsc) return;
Â  Â  Â  Â  Â  musicOsc=audioCtx.createOscillator();
Â  Â  Â  Â  Â  musicOsc.type='triangle';
Â  Â  Â  Â  Â  musicOsc.frequency.value=90;
Â  Â  Â  Â  Â  musicOsc.connect(musicGain);
Â  Â  Â  Â  Â  musicOsc.start();
Â  Â  Â  Â  } else { try{ musicOsc&&musicOsc.stop(); }catch(e){} musicOsc=null; }
Â  Â  Â  }

Â  Â  Â  const keys=new Set();
Â  Â  Â  const mouse={x:0,y:0,down:false};
Â  Â  Â  const touch={leftId:null,rightId:null,left:null,right:null};

Â  Â  Â  let state=null;
Â  Â  Â  let last=performance.now();
Â  Â  Â  let running=false;
Â  Â  Â  let animId=0;
Â  Â  Â  let highScore = parseInt(storage.getItem('tyson_highscore')||'0',10);

Â  Â  Â  function spawnConfetti(x,y,count=20){
Â  Â  Â  Â  state.particles = state.particles || [];
Â  Â  Â  Â  for (let i=0;i<count;i++){
Â  Â  Â  Â  Â  state.particles.push({x,y,vx:Math.random()*4-2,vy:Math.random()*-3-0.5,g:0.08+Math.random()*0.05,life:40+Math.floor(Math.random()*20),size:3+Math.random()*3,color:`hsl(${Math.random()*360},100%,60%)`});
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  function updateParticles(){ if(!state.particles) return; for(const p of state.particles){ p.life--; p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; } state.particles=state.particles.filter(p=>p.life>0); }
Â  Â  Â  function drawParticles(){ if(!state.particles) return; for(const p of state.particles){ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); } }
Â  Â  Â  const baseTaunts=["Oof!","Bat-tastic!","Scissor Fail!","Tyson Wins!","Snip Snip â€” No!","Bonk!","KO!","Clutch!","Outta here!","Sit down!"];
Â  Â  Â  const spicyTaunts=["Bring a bat next time!","Detention ðŸ›Žï¸","Tyson just yeeted your GPA!","Scissors? Bold.","Bat > âœ‚ï¸","Clang!","Snipped your hopes!","Not today, kid!","Curriculum Adjusted!"];
Â  Â  Â  const unhingedTaunts=["Massacre Mode Activated!","WELCOME TO BAT SCHOOL","Homework: Duck.","Legendary Bonk!","Certified Batness","Physics Lesson: Momentum","Clipâ€¦ Clapped.","Principal Approved!"];
Â  Â  Â  function pickTaunt(){ const k=state.playerKills||0; if(k>20) return unhingedTaunts[Math.floor(Math.random()*unhingedTaunts.length)]; if(k>8) return spicyTaunts[Math.floor(Math.random()*spicyTaunts.length)]; return baseTaunts[Math.floor(Math.random()*baseTaunts.length)]; }
Â  Â  Â  function addTaunt(x,y){ state.floats=state.floats||[]; state.floats.push({text:pickTaunt(),x,y,life:60}); }
Â  Â  Â  function updateFloats(){ if(!state.floats) return; for(const f of state.floats){ f.y-=0.6; f.life--; } state.floats=state.floats.filter(f=>f.life>0); }
Â  Â  Â  function drawFloats(){ if(!state.floats) return; ctx.font='700 18px system-ui, -apple-system, Segoe UI'; ctx.textBaseline='bottom'; ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=3; for(const f of state.floats){ ctx.globalAlpha=Math.max(0,f.life/60); ctx.strokeText(f.text,f.x+1,f.y+1); ctx.fillStyle='#fff'; ctx.fillText(f.text,f.x,f.y); ctx.globalAlpha=1; } }

Â  Â  Â  let epRetargetTimer = 0;
Â  Â  Â  function acquireEpTarget(){
Â  Â  Â  Â  const ep=state.epstone; if(!ep) return null;
Â  Â  Â  Â  if(state.bossPhaseActive || state.enemies.length === 0) return {x:state.player.x,y:state.player.y,type:'player'};
Â  Â  Â  Â  let bestHS=null,bestD2=Infinity;
Â  Â  Â  Â  for(const e of state.enemies){ const d2=(e.x-ep.x)**2+(e.y-ep.y)**2; if(d2<bestD2){bestHS=e;bestD2=d2;} }
Â  Â  Â  Â  const playerD2=(state.player.x-ep.x)**2+(state.player.y-ep.y)**2;
Â  Â  Â  Â  if(bestHS && (Math.sqrt(bestD2) > 350 && playerD2 < bestD2 || Math.random() < 0.3)){
Â  Â  Â  Â  Â  Â  return {x:state.player.x,y:state.player.y,type:'player'};
Â  Â  Â  Â  }
Â  Â  Â  Â  return bestHS ? {x:bestHS.x,y:bestHS.y,type:'hs'} : {x:state.player.x,y:state.player.y,type:'player'};
Â  Â  Â  }
Â  Â  Â  function steerEpstoneToward(target,dt){
Â  Â  Â  Â  const ep=state.epstone; if(!ep||!target) return;
Â  Â  Â  Â  let [nx,ny]=norm(target.x-ep.x,target.y-ep.y);
Â  Â  Â  Â  const look=40+ep.speed*0.25; const future={x:ep.x+nx*look,y:ep.y+ny*look,r:ep.r};
Â  Â  Â  Â  for(const r of state.obstacles){ if(circleRectCollide(future,r)){ const cx=clamp(future.x,r.x,r.x+r.w), cy=clamp(future.y,r.y,r.y+r.h); const [px,py]=norm(future.x-cx,future.y-cy); nx+=px*2; ny+=py*2; } }
Â  Â  Â  Â  [nx,ny]=norm(nx,ny); ep.x+=nx*ep.speed*dt; ep.y+=ny*ep.speed*dt;
Â  Â  Â  }

Â  Â  Â  function triggerWildEvent(){
Â  Â  Â  Â  if(!state.crazy) return;
Â  Â  Â  Â  const roll=Math.random();
Â  Â  Â  Â  if(roll<.33){
Â  Â  Â  Â  Â  state.enemies.forEach(e=>e.speedMul=0.7+Math.random()*0.8);
Â  Â  Â  Â  Â  state.wildTimers.push({t:6,type:'speedReset'});
Â  Â  Â  Â  Â  addTaunt(state.player.x,state.player.y-30);
Â  Â  Â  Â  } else if(roll<.66){
Â  Â  Â  Â  Â  for(let i=0;i<8;i++){
Â  Â  Â  Â  Â  Â  state.meteors.push({x:Math.random()*state.W,y:-40-Math.random()*200,vy:200+Math.random()*160,w:14+Math.random()*12,h:28+Math.random()*20,t:5});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  addTaunt(state.player.x,state.player.y-30);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const picks=Math.min(6,state.enemies.length);
Â  Â  Â  Â  Â  for(let i=0;i<picks;i++){
Â  Â  Â  Â  Â  Â  const e=state.enemies[Math.floor(Math.random()*state.enemies.length)];
Â  Â  Â  Â  Â  Â  if(!e) break;
Â  Â  Â  Â  Â  Â  state.enemies.push({x:e.x+randRange(-20,20),y:e.y+randRange(-20,20),r:e.r,speed:e.speed,hp:e.hp,maxHp:e.maxHp,elite:false,disarmed:false,knockT:0,knockVx:0,knockVy:0,touchCd:0,speedMul:1});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  spawnConfetti(state.player.x,state.player.y,30);
Â  Â  Â  Â  }
Â  Â  Â  Â  state.nextWildIn=18+Math.random()*12;
Â  Â  Â  }

Â  Â  Â  function resize(){
Â  Â  Â  Â  const dpr=window.devicePixelRatio||1;
Â  Â  Â  Â  const w=Math.min(wrap.clientWidth,1100);
Â  Â  Â  Â  const h=Math.min(Math.max(wrap.clientHeight,560),820);
Â  Â  Â  Â  canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
Â  Â  Â  Â  canvas.style.width=w+'px'; canvas.style.height=h+'px';
Â  Â  Â  Â  ctx.setTransform(dpr,0,0,dpr,0,0);
Â  Â  Â  Â  if(state) draw();
Â  Â  Â  }
Â  Â  Â  window.addEventListener('resize',resize);

Â  Â  Â  function createLevel(){
Â  Â  Â  Â  const W=parseInt(canvas.style.width)||canvas.width;
Â  Â  Â  Â  const H=parseInt(canvas.style.height)||canvas.height;
Â  Â  Â  Â  const margin=24;
Â  Â  Â  Â  const obstacles=[];
Â  Â  Â  Â  const deskW=120,deskH=60,gapX=40,gapY=40,rows=2,cols=3;
Â  Â  Â  Â  const sx=(W-(cols*deskW+(cols-1)*gapX))/2;
Â  Â  Â  Â  const sy=(H-(rows*deskH+(rows-1)*gapY))/2;
Â  Â  Â  Â  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) obstacles.push({x:sx+c*(deskW+gapX),y:sy+r*(deskH+gapY),w:deskW,h:deskH});
Â  Â  Â  Â  return {W,H,room:{w:W,h:H,margin},obstacles};
Â  Â  Â  }

Â  Â  Â  function createGame(){
Â  Â  Â  Â  const {W,H,room,obstacles}=createLevel();
Â  Â  Â  Â  const player={ x:W*0.5,y:H*0.85,r:16, speed:230,aim:0,hp:3,iFrames:0, swing:{active:false,t:0,duration:0.24,arc:1.9,range:72,cooldown:0}, power:{flameT:0,shrinkT:0} };
Â  Â  Â  Â  const difficulty=clamp(parseInt(diffSel?.value||'2')-1,0,2);
Â  Â  Â  Â  const enemyCount=[24,30,36][difficulty];
Â  Â  Â  Â  const enemySpeed=[85,105,125][difficulty];
Â  Â  Â  Â  const epSpeed=Math.round(enemySpeed*0.85);
Â  Â  Â  Â  const enemies=[];
Â  Â  Â  Â  const spawnR=Math.min(W,H)*0.42;
Â  Â  Â  Â  for(let i=0;i<enemyCount;i++){ const a=i/enemyCount*Math.PI*2; const x=W*0.5+Math.cos(a)*spawnR; const y=H*0.45+Math.sin(a)*spawnR*0.7; enemies.push({x,y,r:14,speed:enemySpeed,hp:1,maxHp:1,elite:false,disarmed:false,knockT:0,knockVx:0,knockVy:0,touchCd:0,speedMul:1}); }
Â  Â  Â  Â  const buffCount=Math.min(5,enemies.length);
Â  Â  Â  Â  const picks=new Set(); while(picks.size<buffCount) picks.add(Math.floor(Math.random()*enemies.length));
Â  Â  Â  Â  for(const idx of picks){ const e=enemies[idx]; e.elite=true; e.hp=2; e.maxHp=2; e.r=18; e.speed=Math.round(e.speed*0.85); }

Â  Â  Â  Â  state={ W,H,room,obstacles,player,enemies, enemySpeed,epSpeed, score:0,t:0, particles:[], powerUps:[], epstone:null, epPhase:1, epTarget:null, playerKills:0,epKills:0, shake:0, floats:[], clones:[], meteors:[], crazy:!!crazyChk.checked, nextWildIn:12+Math.random()*8, wildTimers:[], bossPhaseActive: false };
Â  Â  Â  Â  epRetargetTimer=0;

Â  Â  Â  Â  running=false;
Â  Â  Â  Â  updateHUD(); hide(endOverlay); show(startOverlay); draw();
Â  Â  Â  }

Â  Â  Â  function spawnPowerUp(x,y,type){ state.powerUps.push({type,x,y,r:10,t:0,taken:false}); }
Â  Â  Â  function spawnEpstone(){
Â  Â  Â  Â  const x=state.W*0.5, y=state.H*0.25;
Â  Â  Â  Â  state.epstone={ x,y,r:28,hp:20,maxHp:20,speed:state.epSpeed,disarmed:false, knockT:0,knockVx:0,knockVy:0, batAngle:0,batSpeed:3.2,batArc:1.1,batRange:95, phase:1, orbiters:[], stolenHp: 0 };
Â  Â  Â  Â  state.epTarget=acquireEpTarget();
Â  Â  Â  }

Â  Â  Â  function start(){
Â  Â  Â  Â  running=true; last=performance.now(); hide(startOverlay); cancelAnimationFrame(animId); animId=requestAnimationFrame(loop);
Â  Â  Â  }
Â  Â  Â  function stop(win){
Â  Â  Â  Â  running=false; toggleMusic(false);
Â  Â  Â  Â  endTitle.textContent= win ? 'You Won the Showdown!' : 'Overrun!';
Â  Â  Â  Â  endMsg.textContent = win ? `Score: ${state.score} â€¢ Time: ${Math.floor(state.t)}s â€¢ Final Kills: ${state.playerKills}` : `Use desks to funnel the swarm. Time swings through the thickest part.`;
Â  Â  Â  Â  if(state.score>highScore){ highScore=state.score; storage.setItem('tyson_highscore',String(highScore)); fanfare(); }
Â  Â  Â  Â  bestEl.textContent=highScore;
Â  Â  Â  Â  const txt=encodeURIComponent(`I scored ${state.score} in Tyson vs HS! (${state.playerKills} KOs) #TysonBat #CanvasGame`);
Â  Â  Â  Â  shareBtn.href='https://twitter.com/intent/tweet?text='+txt;
Â  Â  Â  Â  show(endOverlay);
Â  Â  Â  }
Â  Â  Â  function reset(){ createGame(); runCountdown(); }

Â  Â  Â  function spawnClone(){ const c={x:state.player.x,y:state.player.y,r:10,speed:200,life:10}; state.clones.push(c); }
Â  Â  Â  function updateClones(dt){
Â  Â  Â  Â  const alive=[];
Â  Â  Â  Â  for(const c of state.clones){
Â  Â  Â  Â  Â  c.life-=dt;
Â  Â  Â  Â  Â  let best=null,bestD2=Infinity;
Â  Â  Â  Â  Â  for(const e of state.enemies){ const dx=e.x-c.x,dy=e.y-c.y,d2=dx*dx+dy*dy; if(d2<bestD2){best=e;bestD2=d2;} }
Â  Â  Â  Â  Â  if(best){ const [nx,ny]=norm(best.x-c.x,best.y-c.y); c.x+=nx*c.speed*dt; c.y+=ny*c.speed*dt; const er=best.r*(state.player.power.shrinkT>0?0.6:1); const dx=best.x-c.x,dy=best.y-c.y; if(dx*dx+dy*dy<(er+c.r)*(er+c.r)){ best.hp-=1; spawnConfetti(best.x,best.y,10); if(best.hp<=0){ best.disarmed=true; state.score+=80; state.playerKills++; addTaunt(best.x,best.y-10); addShake(0.1); } } }
Â  Â  Â  Â  Â  if(c.life>0) alive.push(c);
Â  Â  Â  Â  }
Â  Â  Â  Â  state.clones=alive;
Â  Â  Â  }

Â  Â  Â  function trySwing(){ const p=state.player; if(p.swing.active||p.swing.cooldown>0) return; p.swing.active=true; p.swing.t=0; thwack(); }

Â  Â  Â  function handleInput(dt){
Â  Â  Â  Â  const p=state.player; let vx=0,vy=0;
Â  Â  Â  Â  if(keys.has('ArrowLeft')||keys.has('a')) vx-=1;
Â  Â  Â  Â  if(keys.has('ArrowRight')||keys.has('d')) vx+=1;
Â  Â  Â  Â  if(keys.has('ArrowUp')||keys.has('w')) vy-=1;
Â  Â  Â  Â  if(keys.has('ArrowDown')||keys.has('s')) vy+=1;
Â  Â  Â  Â  if(touch.left){ const {start,cur}=touch.left; const dx=cur.x-start.x,dy=cur.y-start.y; const [nx,ny]=norm(dx,dy); const mag=Math.min(1,len(dx,dy)/48); vx+=nx*mag; vy+=ny*mag; }
Â  Â  Â  Â  const [nx,ny]=norm(vx,vy); p.x+=nx*p.speed*dt; p.y+=ny*p.speed*dt;
Â  Â  Â  Â  const margin=state.room.margin+p.r; p.x=clamp(p.x,margin,state.W-margin); p.y=clamp(p.y,margin,state.H-margin);
Â  Â  Â  Â  const pc={x:p.x,y:p.y,r:p.r};
Â  Â  Â  Â  for(const r of state.obstacles){ if(circleRectCollide(pc,r)){ const cx=clamp(pc.x,r.x,r.x+r.w), cy=clamp(pc.y,r.y,r.y+r.h); const dx=pc.x-cx,dy=pc.y-cy; if(Math.abs(dx)>Math.abs(dy)) p.y+=Math.sign(dy)*(pc.r-Math.abs(dy)+0.1); else p.x+=Math.sign(dx)*(pc.r-Math.abs(dx)+0.1); pc.x=p.x; pc.y=p.y; } }
Â  Â  Â  Â  if(touch.right){ const {center,cur}=touch.right; p.aim=Math.atan2(cur.y-center.y,cur.x-center.x); } else { const rect=canvas.getBoundingClientRect(); const mx=mouse.x-rect.left,my=mouse.y-rect.top; p.aim=Math.atan2(my-p.y,mx-p.x); }
Â  Â  Â  Â  if(p.swing.cooldown>0) p.swing.cooldown=Math.max(0,p.swing.cooldown-dt);
Â  Â  Â  Â  if(p.swing.active){ p.swing.t+=dt; if(p.swing.t>=p.swing.duration){ p.swing.active=false; p.swing.t=0; p.swing.cooldown=0.18; } }
Â  Â  Â  }

Â  Â  Â  function update(dt){
Â  Â  Â  Â  state.t+=dt;
Â  Â  Â  Â  const p=state.player;
Â  Â  Â  Â  if(p.power.flameT>0) p.power.flameT=Math.max(0,p.power.flameT-dt);
Â  Â  Â  Â  if(p.power.shrinkT>0) p.power.shrinkT=Math.max(0,p.power.shrinkT-dt);
Â  Â  Â  Â  if(p.iFrames>0) p.iFrames=Math.max(0,p.iFrames-dt);

Â  Â  Â  Â  state.crazy=!!crazyChk.checked; state.nextWildIn-=dt; if(state.crazy && state.nextWildIn<=0) triggerWildEvent();
Â  Â  Â  Â  const newTimers=[]; for(const tmr of state.wildTimers){ tmr.t-=dt; if(tmr.t>0) newTimers.push(tmr); else if(tmr.type==='speedReset'){ state.enemies.forEach(e=>e.speedMul=1); } } state.wildTimers=newTimers;

Â  Â  Â  Â  if(!state.epstone && state.playerKills>=10) spawnEpstone();

Â  Â  Â  Â  for(const e of state.enemies){
Â  Â  Â  Â  Â  if(e.disarmed) continue;
Â  Â  Â  Â  Â  const er=e.r*(p.power.shrinkT>0?0.6:1);
Â  Â  Â  Â  Â  if(e.knockT>0){ e.x+=e.knockVx*dt; e.y+=e.knockVy*dt; e.knockT-=dt; }
Â  Â  Â  Â  Â  else { const [nx,ny]=norm(p.x-e.x,p.y-e.y); e.x+=nx*(e.speed*(e.speedMul||1))*dt; e.y+=ny*(e.speed*(e.speedMul||1))*dt; }
Â  Â  Â  Â  Â  const cc={x:e.x,y:e.y,r:er};
Â  Â  Â  Â  Â  for(const r of state.obstacles){ if(circleRectCollide(cc,r)){ const cx=clamp(cc.x,r.x,r.x+r.w), cy=clamp(cc.y,r.y,r.y+r.h); const dx=cc.x-cx,dy=cc.y-cy; if(Math.abs(dx)>Math.abs(dy)) e.y+=Math.sign(dy)*(cc.r-Math.abs(dy)+0.1); else e.x+=Math.sign(dx)*(cc.r-Math.abs(dx)+0.1); cc.x=e.x; cc.y=e.y; } }
Â  Â  Â  Â  Â  if(e.touchCd>0) e.touchCd-=dt;
Â  Â  Â  Â  Â  const dx=e.x-p.x,dy=e.y-p.y;
Â  Â  Â  Â  Â  if(dx*dx+dy*dy<(er+p.r)*(er+p.r)){ if(e.touchCd<=0 && p.iFrames<=0){ p.hp-=1; p.iFrames=1.2; e.touchCd=0.7; addShake(0.18); snip(); if(p.hp<=0){ updateHUD(); stop(false); return; } } }
Â  Â  Â  Â  }

Â  Â  Â  Â  const aliveM=[]; for(const m of state.meteors){ m.y+=m.vy*dt; m.t-=dt;
Â  Â  Â  Â  Â  for(const e of state.enemies){ if(e.disarmed) continue; const er=e.r*(p.power.shrinkT>0?0.6:1); if(e.x>m.x-m.w && e.x<m.x+m.w && e.y>m.y-m.h && e.y<m.y+m.h){ e.hp=0; e.disarmed=true; state.playerKills++; state.score+=50; spawnConfetti(e.x,e.y,12); addTaunt(e.x,e.y-10); } }
Â  Â  Â  Â  Â  if(p.x>m.x-m.w && p.x<m.x+m.w && p.y>m.y-m.h && p.y<m.y+m.h){ if(p.iFrames<=0){ p.hp-=1; p.iFrames=1.0; addShake(0.25); if(p.hp<=0){ updateHUD(); stop(false); return; } } }
Â  Â  Â  Â  Â  if (state.epstone && !state.epstone.disarmed) {
Â  Â  Â  Â  Â  Â  Â  const ep = state.epstone;
Â  Â  Â  Â  Â  Â  Â  if (ep.x > m.x - m.w && ep.x < m.x + m.w && ep.y > m.y - m.h && ep.y < m.y + m.h) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  ep.hp -= 2; addShake(0.15); spawnConfetti(ep.x, ep.y, 15); m.t = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ep.hp <= 0) { ep.disarmed = true; state.score += 500; }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if(m.y<state.H+60 && m.t>0) aliveM.push(m);
Â  Â  Â  Â  } state.meteors=aliveM;

Â  Â  Â  Â  if(state.epstone && !state.epstone.disarmed){
Â  Â  Â  Â  Â  const ep=state.epstone;
Â  Â  Â  Â  Â  if(ep.phase===1 && ep.hp<=12){ ep.phase=2; state.epPhase=2; ep.batSpeed=3.8; ep.batArc=1.25; ep.orbiters=[]; for(let i=0;i<4;i++) ep.orbiters.push({ang:i*Math.PI/2,rad:ep.batRange*0.7}); }
Â  Â  Â  Â  Â  epRetargetTimer-=dt; if(epRetargetTimer<=0){ epRetargetTimer=0.35; state.epTarget=acquireEpTarget()||{x:state.W*0.5,y:state.H*0.5,type:'center'}; }
Â  Â  Â  Â  Â  if(ep.knockT>0){ ep.x+=ep.knockVx*dt; ep.y+=ep.knockVy*dt; ep.knockT-=dt; } else { steerEpstoneToward(state.epTarget,dt); }
Â  Â  Â  Â  Â  const cc={x:ep.x,y:ep.y,r:ep.r};
Â  Â  Â  Â  Â  for(const r of state.obstacles){ if(circleRectCollide(cc,r)){ const cx=clamp(cc.x,r.x,r.x+r.w), cy=clamp(cc.y,r.y,r.y+r.h); const dx=cc.x-cx,dy=cc.y-cy; if(Math.abs(dx)>Math.abs(dy)) ep.y+=Math.sign(dy)*(cc.r-Math.abs(dy)+0.1); else ep.x+=Math.sign(dx)*(cc.r-Math.abs(dx)+0.1); cc.x=ep.x; cc.y=ep.y; } }
Â  Â  Â  Â  Â  ep.batAngle=(ep.batAngle+ep.batSpeed*dt)%(Math.PI*2);
Â  Â  Â  Â  Â  for(const e of state.enemies){ if(e.disarmed) continue; if(withinArc(e.x,e.y,ep.x,ep.y,ep.batAngle,ep.batArc,ep.batRange)){ e.hp-=1; if(e.hp<=0){ e.disarmed=true; state.epKills++; ep.stolenHp += e.maxHp; addShake(0.12); spawnConfetti(e.x,e.y,10); } else { const [nx,ny]=norm(e.x-ep.x,e.y-ep.y); e.knockVx=nx*220; e.knockVy=ny*220; e.knockT=0.1; } } }
Â  Â  Â  Â  Â  if(ep.phase>=2){ for(const o of ep.orbiters){ o.ang+=2.2*dt; const ox=ep.x+Math.cos(o.ang)*o.rad, oy=ep.y+Math.sin(o.ang)*o.rad; const dx=ox-state.player.x,dy=oy-state.player.y; if(dx*dx+dy*dy<(state.player.r+10)*(state.player.r+10)){ if(state.player.iFrames<=0){ state.player.hp-=1; state.player.iFrames=1.0; addShake(0.2); if(state.player.hp<=0){ updateHUD(); stop(false); return; } } } for(const e of state.enemies){ if(e.disarmed) continue; const ex=ox-e.x,ey=oy-e.y; const er=e.r*(state.player.power.shrinkT>0?0.6:1); if(ex*ex+ey*ey<(er+8)*(er+8)){ e.hp-=1; if(e.hp<=0){ e.disarmed=true; state.epKills++; ep.stolenHp += e.maxHp; spawnConfetti(e.x,e.y,8); } } } } }
Â  Â  Â  Â  Â  if(withinArc(p.x,p.y,ep.x,ep.y,ep.batAngle,ep.batArc,ep.batRange+p.r)){ if(p.iFrames<=0){ p.hp-=1; p.iFrames=1.0; addShake(0.18); if(p.hp<=0){ updateHUD(); stop(false); return; } } }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(p.swing.active){
Â  Â  Â  Â  Â  const prog=p.swing.t/p.swing.duration, base=p.aim-p.swing.arc*0.5, cur=base+p.swing.arc*prog, flame=p.power.flameT>0;
Â  Â  Â  Â  Â  for(const e of state.enemies){
Â  Â  Â  Â  Â  Â  if(e.disarmed) continue;
Â  Â  Â  Â  Â  Â  const direct=withinArc(e.x,e.y,p.x,p.y,cur,0.55,p.swing.range);
Â  Â  Â  Â  Â  Â  const splash=flame && !direct && withinArc(e.x,e.y,p.x,p.y,cur,1.2,p.swing.range+10);
Â  Â  Â  Â  Â  Â  if(direct||splash){
Â  Â  Â  Â  Â  Â  Â  e.hp-=1; spawnConfetti(e.x,e.y,8);
Â  Â  Â  Â  Â  Â  Â  if(e.hp<=0){
Â  Â  Â  Â  Â  Â  Â  Â  e.disarmed=true; state.score+=100; state.playerKills++; addShake(0.12); addTaunt(e.x,e.y-10);
Â  Â  Â  Â  Â  Â  Â  Â  if(e.elite && Math.random()<0.6){ const kinds=['flame','shrink','clone']; spawnPowerUp(e.x,e.y,kinds[Math.floor(Math.random()*kinds.length)]); }
Â  Â  Â  Â  Â  Â  Â  } else { const [nx,ny]=norm(e.x-p.x,e.y-p.y); const k=direct?260:200; e.knockVx=nx*k; e.knockVy=ny*k; e.knockT=direct?0.12:0.10; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if(state.epstone && !state.epstone.disarmed){
Â  Â  Â  Â  Â  Â  const ep=state.epstone;
Â  Â  Â  Â  Â  Â  const hit=withinArc(ep.x,ep.y,p.x,p.y,cur,0.55,p.swing.range);
Â  Â  Â  Â  Â  Â  const glance=flame && !hit && withinArc(ep.x,ep.y,p.x,p.y,cur,1.2,p.swing.range+10);
Â  Â  Â  Â  Â  Â  if(hit||glance){
Â  Â  Â  Â  Â  Â  Â  ep.hp-=1; addShake(0.08); spawnConfetti(ep.x,ep.y,6);
Â  Â  Â  Â  Â  Â  Â  if(ep.hp<=0){ ep.disarmed=true; state.score+=500; addShake(0.2); spawnConfetti(ep.x,ep.y,30); }
Â  Â  Â  Â  Â  Â  Â  else { const [nx,ny]=norm(ep.x-p.x,ep.y-p.y); const k=hit?240:200; ep.knockVx=nx*k; ep.knockVy=ny*k; ep.knockT=0.15; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  for(const pu of state.powerUps){ if(pu.taken) continue; pu.t+=dt; const dx=pu.x-p.x,dy=pu.y-p.y; if(dx*dx+dy*dy<(pu.r+p.r)*(pu.r+p.r)){ pu.taken=true; coin(); if(pu.type==='flame') p.power.flameT=Math.max(p.power.flameT,10); if(pu.type==='shrink') p.power.shrinkT=Math.max(p.power.shrinkT,8); if(pu.type==='clone') spawnClone(); } }
Â  Â  Â  Â  state.powerUps=state.powerUps.filter(pu=>!pu.taken);

Â  Â  Â  Â  state.enemies=state.enemies.filter(e=>!e.disarmed);
Â  Â  Â  Â  state.shake=Math.max(0,state.shake-dt*4);
Â  Â  Â  Â  updateParticles(); updateFloats(); updateClones(dt);

Â  Â  Â  Â  if (state.enemies.length === 0 && state.epstone && !state.epstone.disarmed && !state.bossPhaseActive) {
Â  Â  Â  Â  Â  Â  state.bossPhaseActive = true;
Â  Â  Â  Â  Â  Â  state.epstone.hp += state.epstone.stolenHp;
Â  Â  Â  Â  Â  Â  state.epstone.maxHp += state.epstone.stolenHp;
Â  Â  Â  Â  Â  Â  state.epstone.speed *= 1.2;
Â  Â  Â  Â  Â  Â  state.epstone.batSpeed *= 1.2;
Â  Â  Â  Â  Â  Â  addShake(0.5);
Â  Â  Â  Â  Â  Â  vibrate([100, 50, 100]);
Â  Â  Â  Â  Â  Â  state.floats.push({text:"You weren't on my list, Mike!", x:state.W/2 - 150, y:state.H/2, life:180});
Â  Â  Â  Â  Â  Â  sfx(100, .5, 'sawtooth', 0.4);
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (state && state.bossPhaseActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.floats.push({text:"I was an annihilator. That's what I was born for.", x:state.player.x - 180, y:state.player.y - 40, life:180});
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1800);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (state.enemies.length === 0 && (!state.epstone || state.epstone.disarmed)) {
Â  Â  Â  Â  Â  Â  updateHUD();
Â  Â  Â  Â  Â  Â  stop(true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  updateHUD();
Â  Â  Â  }

Â  Â  Â  function draw(){
Â  Â  Â  Â  if(!state) return; const {W,H}=state;
Â  Â  Â  Â  const p=state.player;
Â  Â  Â  Â  ctx.clearRect(0,0,W,H);
Â  Â  Â  Â  ctx.save(); if(state.shake>0) ctx.translate(randRange(-1,1)*state.shake*6,randRange(-1,1)*state.shake*6);

Â  Â  Â  Â  const hue=(state.bossPhaseActive || state.epPhase>=2)?((Date.now()/20)%360):215;
Â  Â  Â  Â  ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,W,H);
Â  Â  Â  Â  ctx.strokeStyle=`hsl(${hue},35%,22%)`; ctx.lineWidth=1;
Â  Â  Â  Â  for(let x=20;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
Â  Â  Â  Â  for(let y=20;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

Â  Â  Â  Â  ctx.strokeStyle='#3b82f6'; ctx.lineWidth=3; ctx.strokeRect(state.room.margin,state.room.margin,W-state.room.margin*2,H-state.room.margin*2);

Â  Â  Â  Â  ctx.fillStyle='#1e293b'; ctx.strokeStyle='#475569'; ctx.lineWidth=2;
Â  Â  Â  Â  for(const r of state.obstacles){ ctx.fillRect(r.x,r.y,r.w,r.h); ctx.strokeRect(r.x,r.y,r.w,r.h); }

Â  Â  Â  Â  ctx.fillStyle='#fb923c'; for(const m of state.meteors){ ctx.fillRect(m.x-m.w/2,m.y-m.h/2,m.w,m.h); }

Â  Â  Â  Â  for(const pu of state.powerUps){ const bob=Math.sin(pu.t*4)*4; ctx.beginPath(); ctx.arc(pu.x,pu.y+bob,pu.r,0,Math.PI*2); ctx.fillStyle=(pu.type==='flame')?'#f59e0b':(pu.type==='shrink'?'#34d399':'#93c5fd'); ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fde68a'; ctx.stroke(); }

Â  Â  Â  Â  drawParticles(); drawFloats();

Â  Â  Â  Â  for(const c of state.clones){ ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fillStyle='#60a5fa'; ctx.fill(); ctx.strokeStyle='#1d4ed8'; ctx.lineWidth=2; ctx.stroke(); }

Â  Â  Â  Â  for(const e of state.enemies){
Â  Â  Â  Â  Â  const er=e.r*(p.power.shrinkT>0?0.6:1);
Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  ctx.translate(e.x, e.y);
Â  Â  Â  Â  Â  const angle = Math.atan2(p.y - e.y, p.x - e.x);
Â  Â  Â  Â  Â  ctx.rotate(angle);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if(e.elite){ const grd=ctx.createRadialGradient(-4,-4,4,0,0,er+2); grd.addColorStop(0,'#e0f2fe'); grd.addColorStop(1,'#60a5fa'); ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(0,0,er,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#e2e8f0'; ctx.stroke(); }
Â  Â  Â  Â  Â  else { ctx.fillStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(0,0,er,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#334155'; ctx.stroke(); }

Â  Â  Â  Â  Â  // Draw scissors
Â  Â  Â  Â  Â  ctx.fillStyle = '#94a3b8'; // metal grey
Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(er - 2, 5, 3, 0, Math.PI*2); ctx.fill();
Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(er - 2, -5, 3, 0, Math.PI*2); ctx.fill();
Â  Â  Â  Â  Â  ctx.strokeStyle = '#475569';
Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  ctx.beginPath(); ctx.moveTo(er, 0); ctx.lineTo(er + 10, 5); ctx.stroke();
Â  Â  Â  Â  Â  ctx.beginPath(); ctx.moveTo(er, 0); ctx.lineTo(er + 10, -5); ctx.stroke();
Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  if(state.epstone && !state.epstone.disarmed){
Â  Â  Â  Â  Â  const ep=state.epstone;
Â  Â  Â  Â  Â  ctx.save(); ctx.shadowBlur=18; ctx.shadowColor='#a855f7'; ctx.fillStyle='rgba(168,85,247,0.9)'; ctx.beginPath(); ctx.arc(ep.x,ep.y,ep.r,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; ctx.restore();
Â  Â  Â  Â  Â  ctx.lineWidth=3; ctx.strokeStyle='#6d28d9'; ctx.beginPath(); ctx.arc(ep.x,ep.y,ep.r,0,Math.PI*2); ctx.stroke();

Â  Â  Â  Â  Â  // Lawyer Symbol
Â  Â  Â  Â  Â  ctx.font = `bold ${ep.r}px sans-serif`;
Â  Â  Â  Â  Â  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(255,255,255,0.6)';
Â  Â  Â  Â  Â  ctx.fillText('Â§', ep.x, ep.y + 2);

Â  Â  Â  Â  Â  // Health Bar
Â  Â  Â  Â  Â  const barW = 60, barH = 8, barX = ep.x - barW/2, barY = ep.y - ep.r - barH - 8;
Â  Â  Â  Â  Â  const hpRatio = Math.max(0, ep.hp / ep.maxHp);
Â  Â  Â  Â  Â  ctx.fillStyle = '#334155'; ctx.fillRect(barX, barY, barW, barH);
Â  Â  Â  Â  Â  ctx.fillStyle = '#a855f7'; ctx.fillRect(barX, barY, barW * hpRatio, barH);
Â  Â  Â  Â  Â  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(barX, barY, barW, barH);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  ctx.save(); ctx.translate(ep.x,ep.y); ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,ep.batRange,ep.batAngle-ep.batArc/2,ep.batAngle+ep.batArc/2); ctx.closePath(); ctx.fillStyle='rgba(168,85,247,0.25)'; ctx.fill(); ctx.restore();
Â  Â  Â  Â  Â  if(ep.phase>=2){ for(const o of ep.orbiters){ const ox=ep.x+Math.cos(o.ang)*o.rad, oy=ep.y+Math.sin(o.ang)*o.rad; ctx.beginPath(); ctx.arc(ox,oy,8,0,Math.PI*2); ctx.fillStyle='#a78bfa'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#6d28d9'; ctx.stroke(); } }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(p.power.flameT>0){ ctx.save(); ctx.shadowBlur=10; ctx.shadowColor='#facc15'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+10,0,Math.PI*2); ctx.strokeStyle='#facc15'; ctx.lineWidth=3; ctx.stroke(); ctx.restore(); }
Â  Â  Â  Â  if(p.power.shrinkT>0){ ctx.save(); ctx.globalAlpha=.35; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+16,0,Math.PI*2); ctx.fillStyle='#34d399'; ctx.fill(); ctx.globalAlpha=1; ctx.restore(); }
Â  Â  Â  Â  if(p.swing.active){ const prog=p.swing.t/p.swing.duration, start=p.aim-p.swing.arc*0.5, cur=start+p.swing.arc*prog; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.arc(p.x,p.y,p.swing.range,start,cur); ctx.closePath(); ctx.fillStyle='rgba(250,204,21,0.25)'; ctx.fill(); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Draw Player with Gloves
Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  ctx.translate(p.x, p.y);
Â  Â  Â  Â  ctx.rotate(p.aim);
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fillStyle='#22c55e'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#065f46'; ctx.stroke();
Â  Â  Â  Â  ctx.fillStyle = '#ef4444'; // Red for gloves
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(p.r - 4, -p.r/2 - 2, 6, 0, Math.PI*2); ctx.fill();
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(p.r - 4, p.r/2 + 2, 6, 0, Math.PI*2); ctx.fill();
Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â Â 
Â  Â  Â  Â  ctx.globalAlpha = 0.25;
Â  Â  Â  Â  if(touch.left) {
Â  Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(touch.left.start.x, touch.left.start.y, 48, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
Â  Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(touch.left.cur.x, touch.left.cur.y, 32, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
Â  Â  Â  Â  }
Â  Â  Â  Â  if(touch.right) {
Â  Â  Â  Â  Â  Â  ctx.beginPath(); ctx.arc(touch.right.center.x, touch.right.center.y, 48, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
Â  Â  Â  Â  }
Â  Â  Â  Â  ctx.globalAlpha = 1;

Â  Â  Â  Â  ctx.restore();
Â  Â  Â  }

Â  Â  Â  function updateHUD(){
Â  Â  Â  Â  hpEl.textContent=state.player.hp;
Â  Â  Â  Â  if(state.bossPhaseActive && state.epstone) {
Â  Â  Â  Â  Â  Â  enemiesEl.textContent = `BOSS: ${state.epstone.hp}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  enemiesEl.textContent=state.enemies.length;
Â  Â  Â  Â  }
Â  Â  Â  Â  scoreEl.textContent=state.score;
Â  Â  Â  Â  timeEl.textContent=`${Math.floor(state.t)}s`;
Â  Â  Â  Â  flameEl.textContent= state.player.power.flameT>0 ? `${Math.ceil(state.player.power.flameT)}s` : (state.player.power.shrinkT>0 ? `Shrink ${Math.ceil(state.player.power.shrinkT)}s` : '0s');
Â  Â  Â  Â  killsEl.textContent=`${state.playerKills}/${state.epKills}`;
Â  Â  Â  Â  bestEl.textContent=highScore;
Â  Â  Â  }

Â  Â  Â  function loop(ts){
Â  Â  Â  Â  if(!running) return;
Â  Â  Â  Â  const dt=Math.min((ts-last)/1000,0.033);
Â  Â  Â  Â  last=ts;
Â  Â  Â  Â  handleInput(dt); update(dt); draw();
Â  Â  Â  Â  animId=requestAnimationFrame(loop);
Â  Â  Â  }

Â  Â  Â  function runCountdown(){
Â  Â  Â  Â  show(startOverlay);
Â  Â  Â  Â  let remaining = 3;
Â  Â  Â  Â  countNum.textContent = String(remaining);
Â  Â  Â  Â  countLabel.textContent = 'Starting inâ€¦';

Â  Â  Â  Â  const tick = () => {
Â  Â  Â  Â  Â  remaining -= 1;
Â  Â  Â  Â  Â  if(remaining <= 0){
Â  Â  Â  Â  Â  Â  hide(startOverlay);
Â  Â  Â  Â  Â  Â  start();
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  countNum.textContent = String(remaining);
Â  Â  Â  Â  Â  Â  setTimeout(tick, 1000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  setTimeout(tick, 1000);
Â  Â  Â  }

Â  Â  Â  window.addEventListener('keydown',(e)=>{ ensureAudio(); const k=e.key.toLowerCase(); if(['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(k)) keys.add(k); if(k===' '){ e.preventDefault(); trySwing(); } });
Â  Â  Â  window.addEventListener('keyup',(e)=>{ keys.delete(e.key.toLowerCase()); });
Â  Â  Â  canvas.addEventListener('mousemove',(e)=>{ mouse.x=e.clientX; mouse.y=e.clientY; });
Â  Â  Â  canvas.addEventListener('mousedown',()=>{ ensureAudio(); if(!muteChk.checked) thwack(); trySwing(); });

Â  Â  Â  function canvasPos(touchEvent,t){ const rect=canvas.getBoundingClientRect(); return {x:t.clientX-rect.left,y:t.clientY-rect.top}; }
Â  Â  Â  canvas.addEventListener('touchstart',(e)=>{ ensureAudio(); e.preventDefault(); for(const t of e.changedTouches){ const pos=canvasPos(e,t); const left=pos.x<canvas.clientWidth/2; if(left && touch.leftId===null){ touch.leftId=t.identifier; touch.left={start:pos,cur:pos}; } else if(!left && touch.rightId===null){ touch.rightId=t.identifier; touch.right={center:pos,cur:pos}; trySwing(); } } },{passive:false});
Â  Â  Â  canvas.addEventListener('touchmove',(e)=>{ e.preventDefault(); for(const t of e.changedTouches){ const pos=canvasPos(e,t); if(t.identifier===touch.leftId && touch.left) touch.left.cur=pos; if(t.identifier===touch.rightId && touch.right) touch.right.cur=pos; } },{passive:false});
Â  Â  Â  canvas.addEventListener('touchend',(e)=>{ e.preventDefault(); for(const t of e.changedTouches){ if(t.identifier===touch.leftId){ touch.leftId=null; touch.left=null; } if(t.identifier===touch.rightId){ touch.rightId=null; touch.right=null; } } },{passive:false});

Â  Â  Â  if(resetBtn) resetBtn.addEventListener('click', reset);
Â  Â  Â  if(diffSel)Â  diffSel.addEventListener('change', reset);
Â  Â  Â  if(muteChk)Â  muteChk.addEventListener('change', ()=>{ if(muteChk.checked) toggleMusic(false); else { ensureAudio(); toggleMusic(true);} });
Â  Â  Â  if(restartBtn) restartBtn.addEventListener('click', ()=>location.reload());
Â  Â  Â  if(againBtn)Â  Â againBtn.addEventListener('click', reset);

Â  Â  Â  window.startGame = ()=>{};

Â  Â  Â  resize();
Â  Â  Â  createGame();
Â  Â  Â  bestEl.textContent = highScore;
Â  Â  Â  setTimeout(runCountdown, 0);
Â  Â  })();
Â  });
Â  </script>
</body>
</html>